#!/bin/sh

### INIT ######################################################################

if [ -z "${1}" ] || [ "$1" = "-h" ] || [ "$1" = "--help" ]; then
    echo "Downloads any website for offline use."
    echo ""
    echo "Usage: websitedownloader <dns_domain> <path_to_save_to> [--pack]"
    echo "Do not enter the full URL, only the DNS. Without the www ."
    echo "A new sub-folder for the website will be created automatically."
    echo "Add the parameter '--pack' to package the website to a zip file."
    echo "Will also add a date stamp to the filename."
    echo ""
    echo "Example use: websitedownloader example.org ./my-offline-websites"
    echo "             websitedownloader google.se ."
    echo "             websitedownloader google.se . --pack"
    exit 0
fi

### VARIABLES #################################################################

DOMAIN=$1

SAVE_TO="$2"
if [ -z "$SAVE_TO" ]; then
    BASEPATH="./"
else
    BASEPATH=$SAVE_TO"/"
fi

PACK="$3"

### MAIN ######################################################################

# figure out the actual URL
DOMAIN_FINAL=$(curl -Ls -o /dev/null -w %"{url_effective}" "$DOMAIN") || exit 1

# set a proper foldername
PATHNAME=$(printf "%s" "$DOMAIN_FINAL" | sed 's/\//-/g' | sed 's/-$//g' |
    tr -dc '[:alnum:]\.\-\n\r' | tr '[:upper:]' '[:lower:]' |
    sed -e 's/http--//g' -e 's/https--//g') || exit 1
SAVEPATH="$BASEPATH""$PATHNAME"

# already downloaded
if [ -d "$SAVEPATH" ]; then
    echo "Folder already exists: $SAVEPATH"
    exit 1
fi

# info
echo "Downloading website: $DOMAIN_FINAL --> $SAVEPATH"

# download
wget -q \
    --user-agent=Mozilla \
    --no-cookies \
    --timestamping \
    --recursive \
    --convert-links \
    --no-parent \
    --adjust-extension \
    --page-requisites \
    --max-redirect=0 \
    --no-host-directories \
    "$DOMAIN_FINAL" --directory-prefix "$SAVEPATH"

if [ "$PACK" = "--pack" ]; then
    TIMESTAMP=$(date -u +"%y%m%d")
    FILE_ZIP="$SAVEPATH""_""$TIMESTAMP.zip"
    echo "Packing website: $SAVEPATH --> $FILE_ZIP"
    zip -qr "$FILE_ZIP" "$SAVEPATH" || exit 1
fi
